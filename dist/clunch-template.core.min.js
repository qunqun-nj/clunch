/*!
 * clunch.js <core@template> - 🎨 The Progressive JavaScript Interactive Picture Framework.
 * git+https://github.com/hai2007/clunch.git
 *
 * author hai2007 < https://hai2007.gitee.io/sweethome >
 *
 * version 0.1.0-alpha.1
 *
 * Copyright (c) 2020 hai2007 走一步，再走一步。
 * Released under the MIT license
 *
 * Date:Sat Nov 28 2020 18:48:21 GMT+0800 (GMT+08:00)
 */
(function(){"use strict";function n(e){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){n=function(e){return typeof e}}else{n=function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}}return n(e)}function r(e){var t=n(e);return e!=null&&(t==="object"||t==="function")}var t=Object.prototype.toString;function i(e){if(e==null){return e===undefined?"[object Undefined]":"[object Null]"}return t.call(e)}function e(e){var t=n(e);return t==="string"||t==="object"&&e!=null&&!Array.isArray(e)&&i(e)==="[object String]"}function o(e){if(!r(e)){return false}var t=i(e);return t==="[object Function]"||t==="[object AsyncFunction]"||t==="[object GeneratorFunction]"||t==="[object Proxy]"}function a(e){if(e===null||n(e)!=="object"||i(e)!="[object Object]"){return false}if(Object.getPrototypeOf(e)===null){return true}var t=e;while(Object.getPrototypeOf(t)!==null){t=Object.getPrototypeOf(t)}return Object.getPrototypeOf(e)===t}var s=function e(t,r){return r!==null&&n(r)==="object"&&t.indexOf(r.nodeType)>-1&&!a(r)};var b=e;var $=o;var l=function e(t){return Array.isArray(t)};var u=function e(t){return s([1,9,11],t)};var f=[];var d=13;var c=400;var p=null;function h(t,e,r){var l={timer:function e(t,r,n){if(!t){throw new Error("Tick is required!")}r=r||c;var i=(new Date).valueOf()+"_"+(Math.random()*1e3).toFixed(0);f.push({id:i,createTime:new Date,tick:t,duration:r,callback:n});l.start();return i},start:function e(){if(!p){p=setInterval(l.tick,d)}},tick:function e(){var t,r,e,n,i,o,a,s=f;f=[];f.length=0;for(r=0;r<s.length;r++){i=s[r];t=i.createTime;e=i.tick;o=i.duration;n=i.callback;a=(+new Date-t)/o;a=a>1?1:a;e(a);if(a<1&&i.id){f.push(i)}else if(n){n(a)}}if(f.length<=0){l.stop()}},stop:function e(){if(p){clearInterval(p);p=null}}};var n=l.timer(function(e){t(e)},e,r);return function(){var e;for(e in f){if(f[e].id==n){f[e].id=undefined;return}}}}var v=function e(t,r){for(var n in r){try{t[n]=r[n]}catch(e){throw new Error("Illegal property value！")}}return t};var g={whitespace:"[\\x20\\t\\r\\n\\f]"};var m=function e(t){if(/^[_$]/.test(t)){console.warn("The beginning of _ or $ is not allowed："+t)}};function y(e,t){for(var r in t){try{e[r]=t[r]}catch(e){throw new Error("Illegal property value！")}}return e}function _(l){l=y({u:.5},l);var u,f,d;var c=function e(t){if(u){var r=(t-f)/(d-f),n=r*r,i=r*n;var o=i*u[0]+n*u[1]+r*u[2]+u[3];return o*(d-f)}else throw new Error("You shoud first set the position!")};c.setP=function(e,t,r,n,i,o){if(e<r){f=e;d=r;var a=l.u*i,s=l.u*o;t/=r-e;n/=r-e;u=[2*t-2*n+a+s,3*n-3*t-2*a-s,a,t]}else throw new Error("The point x-position should be increamented!");return c};return c}function w(i){i=v({t:0},i);var o,r;var a=function e(t){if(o){r=-1;while(r+1<o.x.length&&(t>o.x[r+1]||r==-1&&t>=o.x[r+1])){r+=1}if(r==-1||r>=o.h.length)throw new Error("Coordinate crossing!");return o.h[r](t)}else{throw new Error("You shoud first set the position!")}};a.setT=function(e){if(typeof e==="number"){i.t=e}else{throw new Error("Expecting a figure!")}return a};a.setP=function(e){o={x:[],h:[]};var t,r=(e[1][1]-e[0][1])/(e[1][0]-e[0][0]),n;o.x[0]=e[0][0];for(t=1;t<e.length;t++){if(e[t][0]<=e[t-1][0])throw new Error("The point position should be increamented!");o.x[t]=e[t][0];n=t<e.length-1?(e[t+1][1]-e[t-1][1])/(e[t+1][0]-e[t-1][0]):(e[t][1]-e[t-1][1])/(e[t][0]-e[t-1][0]);o.h[t-1]=_({u:(1-i.t)*.5}).setP(e[t-1][0],e[t-1][1],e[t][0],e[t][1],r,n);r=n}return a};return a}function x(e,t){var r=document.defaultView&&document.defaultView.getComputedStyle?document.defaultView.getComputedStyle(e,null):e.currentStyle;return b(t)?r.getPropertyValue(t):r}var N=function e(t){var r=document.getElementsByTagName("head")[0];r.style["color"]=t;var n=x(r,"color");var i=n.replace(/^rgba?\(([^)]+)\)$/,"$1").split(new RegExp("\\,"+g.whitespace));return[+i[0],+i[1],+i[2],i[3]==undefined?1:+i[3]]};var T=function e(t,r){if(!(r&&r>=0&&r<=1))r=1;var n=[];for(var i=1;i<=t;i++){n.push("rgba("+(Math.random(1)*230+20).toFixed(0)+","+(Math.random(1)*230+20).toFixed(0)+","+(Math.random(1)*230+20).toFixed(0)+","+r+")")}return n};function O(e){var u=e||{},f,n;var i=function e(){var a=[],s=0,l=0;(function e(t,r){if(r>l)l=r;var n;for(n=0;n<t.children.length;n++){e(f[t.children[n]],r+1)}f[t.id].left=r+.5;if(n==0){if(a[r]==undefined)a[r]=-.5;if(a[r-1]==undefined)a[r-1]=-.5;f[t.id].top=a[r]+1;var i=a[r]+1+(f[t.pid].children.length-1)*.5;if(i-1<a[r-1])f[t.id].top=a[r-1]+1-(f[t.pid].children.length-1)*.5}else{f[t.id].top=(f[t.children[0]].top+f[t.children[n-1]].top)*.5}if(f[t.id].top<=a[r]){var o=a[r]+1-f[t.id].top;(function e(t,r){f[t].top+=o;if(a[r]<f[t].top)a[r]=f[t].top;var n;for(n=0;n<f[t].children.length;n++){e(f[t].children[n],r+1)}})(t.id,r)}a[r]=f[t.id].top;if(f[t.id].top+.5>s)s=f[t.id].top+.5})(f[n],0);return{node:f,root:n,size:s,deep:l+1}};var o=function e(o){var a={};var t=u.root(o),s,r;s=r=u.id(t);a[s]={data:t,pid:null,id:s,children:[]};var l=1;(function e(t,r){var n=u.child(t,o),i;l+=n?n.length:0;for(i=0;n&&i<n.length;i++){s=u.id(n[i]);a[r].children.push(s);a[s]={data:n[i],pid:r,id:s,children:[]};e(n[i],s)}})(t,s);return{value:[r,a],num:l}};var t=function e(t){var r=o(t);f=r.value[1];n=r.value[0];if(r.num==1){f[n].left=.5;f[n].top=.5;return{deep:1,node:f,root:n,size:1}}return i()};t.root=function(e){u.root=e;return t};t.child=function(e){u.child=e;return t};t.id=function(e){u.id=e;return t};return t}var k=function e(t,r,n,i,o){var a=Math.cos(n),s=Math.sin(n);return[+((i-t)*a-(o-r)*s+t).toFixed(7),+((i-t)*s+(o-r)*a+r).toFixed(7)]};var z=function e(t,r,n,i,o){var a=Math.sqrt(t*t+r*r);return[+(t*n/a+i).toFixed(7),+(r*n/a+o).toFixed(7)]};var E=function e(t,r,n,i,o){return[+(n*(i-t)+t).toFixed(7),+(n*(o-r)+r).toFixed(7)]};var j=function e(o){o=v({d:[1,1],c:[0,0],p:[0,0]},o);var a={rotate:function e(t){var r=o.d[0]+o.p[0],n=o.d[1]+o.p[1];var i=k(o.p[0],o.p[1],t,r,n);o.d=[i[0]-o.p[0],i[1]-o.p[1]];return a},move:function e(t){o.p=z(o.d[0],o.d[1],t,o.p[0],o.p[1]);return a},scale:function e(t){o.p=E(o.c[0],o.c[1],t,o.p[0],o.p[1]);return a},value:function e(){return o.p}};return a};function A(b){b=v({"begin-deg":0,deg:Math.PI*2},b);var _=O().root(b.root).child(b.child).id(b.id);var t=function e(t){var r=_(t);for(var n in r.node){r.node[n].deep=r.node[n].left-.5}if(b.type==="LR"||b.type==="RL"){var i=b.width/r.deep;if("RL"===b.type)i*=-1;var o=b.height/(r.size- -.5);for(var a in r.node){var s=r.node[a];r.node[a].left=+(("RL"==b.type?b.width:0)- -s.left*i).toFixed(7);r.node[a].top=+(s.top*o).toFixed(7)}}else if(b.type==="TB"||b.type==="BT"){var l=b.height/r.deep;if("BT"==b.type)l*=-1;var u=b.width/(r.size- -.5);var f,d;for(var c in r.node){var p=r.node[c];f=p.left;d=p.top;r.node[c].top=+(("BT"==b.type?b.height:0)- -f*l).toFixed(7);r.node[c].left=+(d*u).toFixed(7)}}else if(b.type==="circle"){if(r.deep==1&&r.size==1){r.node[r.root].left=b.cx;r.node[r.root].top=b.cy}else{var h=b.radius/(r.deep-1);var v=b.deg/(r.size- -.5);for(var g in r.node){var m=r.node[g];r.node[g].deg=(b["begin-deg"]- -v*m.top)%(Math.PI*2);var y=k(b.cx,b.cy,r.node[g].deg,b.cx- -h*(m.left-.5),b.cy);r.node[g].left=+y[0];r.node[g].top=+y[1]}}}if($(b.drawer)){b.drawer(r);return e}else{return r}};t.config=function(e){b=v(b,e);return t};t.drawer=function(e){b.drawer=e;return t};return t}function R(i){var t=[];var e=function e(n){if(["boolean","number","json","string","color","any"].indexOf(i[n])>-1){t.unshift(function(t){var r=arguments.length>0?false:true;return function(e){return{type:i[n],required:r,animation:e,default:t}}})}else{t.unshift({$animation:h,$cardinal:w,$formatColor:N,$getRandomColors:T,$tree:A,$dot:j,$rotate:k,$move:z,$scale:E}[i[n]])}};for(var r=i.length-2;r>=0;r--){e(r)}return i[i.length-1].apply(this,t)}function S(e,y){return function e(t,r){var n=[];for(var i=0;i<t.length;i++){var o=t[i];if(r||o.name in y){var a={name:o.name,attrs:{},events:[]};var s=r?{attrs:y[r].subAttrs[o.name]}:y[o.name];for(var l in o.attrs){if(/^c\-bind\:/.test(l)){o.attrs[l.replace(/^c\-bind\:/,"")]={isBind:true,express:o.attrs[l]}}else if(/^c\-on\:/.test(l)){var u=(l.replace(/^c\-on\:/,"")+"@default").split("@");a.events.push({event:u[0],region:u[1],method:o.attrs[l]})}else if("c-for"==l){var f=/^ {0,}\(/.test(o.attrs[l]);var d=f?/^ {0,}\( {0,}([0-9a-zA-Z_$]+) {0,}, {0,}([0-9a-zA-Z_$]+) {0,}\) {1,}in {1,}([^ ]+) {0,}$/.exec(o.attrs[l]):/^ {0,}([0-9a-zA-Z_$]+) {1,}in {1,}([^ ]+) {0,}$/.exec(o.attrs[l]);a["c-for"]={key:f?d[2]:null,value:d[1],data:f?d[3]:d[2]}}else if("c-if"==l){a["c-if"]=o.attrs[l]}else{o.attrs[l]={isBind:false,express:o.attrs[l]}}}for(var c in s.attrs){var p=s.attrs[c];if(p.required&&!(c in o.attrs)){throw new Error("attrs."+c+" is required for series "+o.name+"!")}a.attrs[c]={animation:p.animation,type:p.type,value:c in o.attrs?o.attrs[c]:{isBind:false,express:p["default"]}}}var h=[],v=[],g=[];if(o.children){for(var m=0;m<o.children.length;m++){if(b(o.children[m])){g.push(o.children[m])}else if(s.subAttrs&&o.children[m].name in s.subAttrs){v.push(o.children[m])}else{h.push(o.children[m])}}}a.children=e(h);a.subAttrs=e(v,o.name);a.text=g;n.push(a)}else{console.error("Series "+o.name+" is not defined!")}}return n}(e)}function F(e){e.prototype.$$init=function(e){this.__options=e;this.__data=l(e.data)?R(e.data):$(e.data)?e.data():e.data;this._isMounted=false;this._isDestroyed=false;for(var t in e.methods){m(t);this[t]=l(e.methods[t])?R(e.methods[t]):e.methods[t]}for(var r in this.__data){m(r);this[r]=this.__data[r]}this.__renderFlag=!!e.render||!!e.template;if(!!e.render){this.__renderAOP=S(e.render,this.__defineSerirs)}else if(!!e.template){this.__renderOptions=this.$$templateCompiler(e.template);this.__renderAOP=S(this.__renderOptions,this.__defineSerirs)}}}function P(e){e.prototype.$$lifecycle=function(e){if($(e)){e()}else{if(["created","beforeMount","mounted","beforeUnmount","unmounted","beforeUpdate","updated","beforeResize","resized","beforeDraw","drawed","beforeDestroy","destroyed"].indexOf(e)>-1&&$(this.__options[e])){this.__options[e].call(this)}}return this}}function C(e){e.prototype.$$updateView=function(){this.$$lifecycle("beforeDraw");this.$$lifecycle("drawed")};e.prototype.$$updateWithSize=function(){this.$$lifecycle("beforeResize");this.$$lifecycle("resized")};e.prototype.$$updateWithData=function(){this.$$lifecycle("beforeUpdate");this.$$lifecycle("updated")}}function M(n){var e=function e(t){var r=n.__data[t];n[t]=r;Object.defineProperty(n,t,{get:function e(){return r},set:function e(t){r=t;n.$$updateWithData()}})};for(var t in n.__data){e(t)}}function D(t){if(!(this instanceof D)){console.error("Clunch is a constructor and should be called with the `new` keyword");return}["beforeCreate","created","beforeMount","mounted","beforeUnmount","unmounted","beforeUpdate","updated","beforeResize","resized","beforeDestroy","destroyed"].forEach(function(e){if(l(t[e])){t[e]=R(t[e])}});this.$$lifecycle(t.beforeCreate);this.$$init(t);M(this);this.$$lifecycle("created");if(u(t.el)){this.$mount(t.el)}}F(D);P(D);C(D);D.prototype.__defineSerirs={};function B(e){try{e.__resizeObserver=new ResizeObserver(function(){e.$$updateWithSize()});e.__resizeObserver.observe(e.__el)}catch(e){console.info(e);console.error("ResizeObserver undefined!")}}function L(e){var t=R(e);for(var r in t.attrs){if($(t.attrs[r])){t.attrs[r]=t.attrs[r](false)}}for(var n in t.subAttrs){for(var i in t.subAttrs[n]){if($(t.subAttrs[n][i])){t.subAttrs[n][i]=t.subAttrs[n][i](false)}}}return t}function I(n){n.series=function(e,t){if(arguments.length==1){for(var r in e){n.series(r,e[r])}}else{if($(n.prototype.__defineSerirs[e])){console.warn("The series["+e+"] has been registered!")}n.prototype.__defineSerirs[e]=L(t)}return n}}I(D);D.prototype.$mount=function(e){if(this._isDestroyed){console.warn("The clunch has been destroyed!");return}if(this._isMounted){console.warn("The clunch is already mounted!");return}if(!u(e)){console.warn("Mount node does not exist!");return}this.$$lifecycle("beforeMount");if(!this.__renderFlag){this.__renderOptions=this.$$templateCompiler(e.innerHTML);this.__renderAOP=S(this.__renderOptions,this.__defineSerirs)}this.__el=e;e.innerHTML="<canvas>非常抱歉，您的浏览器不支持canvas!</canvas>";this.__canvas=e.getElementsByTagName("canvas")[0];this.$$updateWithData();B(this);this._isMounted=true;this.$$lifecycle("mounted");return this};D.prototype.$unmount=function(){};D.prototype.$destroy=function(){};D.series("group",[function(){return{attrs:{}}}]);var U={blankReg:new RegExp("[\\x20\\t\\r\\n\\f]"),blanksReg:/^[\x20\t\r\n\f]{0,}$/,identifier:/^[a-zA-Z_$][0-9a-zA-Z_$]{0,}$/};function Y(o){var a={},s=0;o=o.trim();var e=function e(){var t="",r="";for(;s<o.length;s++){if(U.blanksReg.test(o[s])||s==o.length-1){t+=o[s];if(!U.blanksReg.test(t)){a[t.trim()]=""}s+=1;break}else if(o[s]=="="){s+=1;var n=null,i=-1;if(o.substr(s,1)=='"'||o.substr(s,1)=="'"){n=o.substr(s,1);i=1;s+=1}else if(o.substr(s,2)=='"'||o.substr(s,2)=="'"){n=o.substr(s,2);i=2;s+=2}if(n!==null){for(;s<o.length;s++){if(o.substr(s,i)==n){a[t.trim()]=r.trim();s+=2;break}else{r+=o[s]}}}else{for(;s<o.length;s++){if(U.blanksReg.test(o[s])){a[t.trim()]=r.trim();s+=1;break}else{r+=o[s]}}}break}else{t+=o[s]}}if(s<o.length){e()}};e();return a}function q(u){var f=-1,d=null;var c=false,p="";var h=["script","pre","style","code"];var v=function e(){d=f++<u.length-1?u[f]:null;return d};var g=function e(t){return u.substring(f,t+f>u.length?u.length:t+f)};v();while(U.blankReg.test(d)&&f<u.length-1){v()}return function(){var e=d,t={};if(e==null)return null;if(c){t.type="textcode";t.tagName=e;while(g(p.length+3)!="</"+p+">"&&f<u.length){t.tagName+=v()}t.tagName=t.tagName.replace(/<$/,"");c=false;return t}if(g(4)=="\x3c!--"){t.type="comment";t.tagName=e;while(g(3)!="--\x3e"&&f<u.length){t.tagName+=v()}v();v();v();t.tagName=t.tagName.replace(/^<!--/,"").replace(/-$/,"");return t}if(g(9)=="<!DOCTYPE"){t.type="DOCTYPE";t.tagName=e;while(g(1)!=">"&&f<u.length){t.tagName+=v()}v();t.tagName=t.tagName.replace(/^<!DOCTYPE/,"").replace(/>$/,"");return t}else if(e=="<"){var r=false,n=null,i=null;while(r||d!=">"&&f<u.length){e+=v();if(r){var o=g(i+1).substring(1);if(o==n){r=false}}else{var a=g(2);if(a=='="'||a=="='"){n=a.replace("=","");i=1;r=true}a=g(3);if(a=='="'||a=="='"){n=a.replace("=","");i=2;r=true}}}if(/^<\//.test(e)){t.tagName=e.replace(/^<\//,"").replace(/>$/,"");t.type="endTag"}else{if(/\/>$/.test(e)){t.type="fullTag";e=e.replace(/\/>$/,"")}else{t.type="beginTag";e=e.replace(/>$/,"")}e=e.replace(/^</,"");t.tagName="";var s=0;for(;s<e.length;s++){if(e[s]==" ")break;t.tagName+=e[s]}var l=e.substring(s);if(U.blanksReg.test(l)){t.attrs={}}else{t.attrs=Y(l)}}}else{t.type="textcode";t.tagName=d;while(g(1)!="<"&&f<u.length){t.tagName+=v()}t.tagName=t.tagName.replace(/<$/,"");f-=1}if(t.type=="beginTag"){if(h.indexOf(t.tagName.toLowerCase())>-1){c=true;p=t.tagName}}else if(t.type=="endTag"){if(h.indexOf(t.tagName.toLowerCase())>-1){c=false}}v();return t}}function V(e){e=W(e);var t=0,r=[];e.forEach(function(e){if(e.type=="beginTag"){r.push({type:"tag",name:e.tagName,attrs:e.attrs,__deep__:++t,__tagType__:"double"})}else if(e.type=="endTag"){t-=1}else if(e.type=="textcode"){r.push({type:"text",content:e.tagName,__deep__:t+1})}else if(e.type=="comment"){r.push({type:"comment",content:e.tagName,__deep__:t+1})}else{r.push({type:"tag",name:e.tagName,attrs:e.attrs,__deep__:t+1,__tagType__:"single"})}});return r}var W=function e(n){var i=[];n.forEach(function(e,t){if(e.type=="beginTag"){i.push([t,e.tagName])}else if(e.type=="endTag"){while(i.length>0){var r=i.pop();if(r[1]==e.tagName){break}else{n[r[0]].type="fullTag"}}}});return n};function Z(e,t){if(!b(e))throw new Error("Template must be a String!");var r=q(e.trim());var n=r(),i=[];while(n!=null){if(n.type=="textcode"&&U.blanksReg.test(n.tagName));else if(n.type=="DOCTYPE");else if(n.type=="comment"){if(t){i.push(n)}}else{i.push(n)}n=r()}i=V(i);var o=[null],a=0;for(var s=0;s<i.length;s++){var l=s,u=i[s].__deep__;i[s].childNodes=[];i[s].preNode=null;i[s].nextNode=null;var f=o[o.length-1];var d=o.length>1?o[o.length-2]:null;if(u==a){i[l].preNode=f;i[f].nextNode=l;i[l].parentNode=d;i[d].childNodes.push(l);o[o.length-1]=l}else if(u>a){i[l].parentNode=f;if(f!=null)i[f].childNodes.push(l);o.push(l)}else{var c=o[o.length-1-(a-u)];var p=o[o.length-2-(a-u)];i[l].preNode=c;if(c!=null)i[c].nextNode=l;i[l].parentNode=p;if(p!=null)i[p].childNodes.push(l);for(var h=0;h<a-u;h++){o.pop()}o[o.length-1]=l}a=u}return i}function H(e){var o=Z("<clunch>"+e+"</clunch>");return function e(t){var r=[];for(var n=0;n<t.childNodes.length;n++){var i=o[t.childNodes[n]];if(i.type=="tag"){r.push({name:i.name,attrs:i.attrs,children:e(i)})}else{r.push(i.content.trim())}}return r}(o[0])}D.prototype.$$templateCompiler=H;if((typeof module==="undefined"?"undefined":n(module))==="object"&&n(module.exports)==="object"){module.exports=D}else{window.Clunch=D}})();